#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω..."

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
echo "üì¶ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ..."
php artisan down --message="–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..." --retry=60

# 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git
echo "üì• –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git..."
git pull origin main

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
composer install --optimize-autoloader --no-dev

echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# 4. –°–±–æ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
echo "üî® –°–æ–±–∏—Ä–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞..."
npm run build:prod

# 5. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à..."
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# 6. –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
php artisan migrate --force

# 7. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
echo "‚ö° –ö—ç—à–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞..."
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
chmod -R 755 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä–∫—É..."
if [ ! -f "public/build/manifest.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: manifest.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"

# 10. –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
echo "üîÑ –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ..."
php artisan up

echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://meteo.element-agro.ru"

# 11. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
curl -s -o /dev/null -w "%{http_code}" https://meteo.element-agro.ru || echo "–°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω" 